name: cleanup-untagged-images

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'Delete images older than (days)'
        required: true
        default: '90'
        type: string
      dry_run:
        description: 'Dry run'
        required: true
        default: true
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Clean Images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS: ${{ inputs.days_old }}
          DRY_RUN: ${{ inputs.dry_run }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          echo "| Package | Image ID | Created At | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          CUTOFF_DATE=$(date -d "$DAYS days ago" +%Y-%m-%d)
          CUTOFF_TS=$(date -d "$CUTOFF_DATE" +%s)
          echo "Targeting images older than: $CUTOFF_DATE"

          echo "Fetching packages list for repo: $REPO..."

          PACKAGES=$(gh api graphql -F owner=$OWNER -F repo=$REPO -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                packages(first: 100, packageType: CONTAINER) {
                  nodes {
                    name
                  }
                }
              }
            }
          ' --jq '.data.repository.packages.nodes[].name')

          if [ -z "$PACKAGES" ]; then
            echo "No packages found or accessible."
            exit 0
          fi

          for PKG in $PACKAGES; do
            echo "Checking package: $PKG"
            
            versions=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/$OWNER/packages/container/$PKG/versions?per_page=100")

            echo "$versions" | jq -r --argjson cutoff "$CUTOFF_TS" '.[] | select((.metadata.container.tags | length) == 0) | select((.created_at | fromdateiso8601) < $cutoff) | "\(.id) \(.created_at)"' | \
            while read -r version_id created_at; do
              
              if [ "$DRY_RUN" = "true" ]; then
                echo "DRY RUN: Would delete $PKG : $version_id"
                echo "| $PKG | $version_id | $created_at | Dry Run |" >> $GITHUB_STEP_SUMMARY
              else
                echo "DELETING: $PKG : $version_id"
                
                set +e
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/orgs/$OWNER/packages/container/$PKG/versions/$version_id"
                
                exit_code=$?
                set -e 

                if [ $exit_code -eq 0 ]; then
                  echo "| $PKG | $version_id | $created_at | Deleted |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "Error deleting. Token might lack scope for this specific package."
                  echo "| $PKG | $version_id | $created_at | Forbidden (403) |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          done