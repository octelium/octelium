name: Cleanup Untagged OCI Images

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run"
        required: true
        default: true
        type: boolean
      retention_days:
        description: "Delete untagged images older than X days"
        required: true
        default: "90"
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete Untagged Images
        uses: actions/github-script@v7
        env:
          DRY_RUN: "${{ inputs.dry_run }}"
          RETENTION_DAYS: "${{ inputs.retention_days }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const org = context.repo.owner;
            const dryRun = process.env.DRY_RUN === "true";
            const retentionDays = parseInt(process.env.RETENTION_DAYS, 10);

            if (isNaN(retentionDays) || retentionDays < 0) {
              core.setFailed(`Invalid retention_days: ${process.env.RETENTION_DAYS}`);
              return;
            }

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

            console.log(`Mode: ${dryRun ? "DRY RUN" : "DELETION"}`);
            console.log(`Cutoff: ${cutoffDate.toISOString()}`);

            try {
              const packages = await github.paginate(
                github.rest.packages.listPackagesForOrganization,
                { org, package_type: "container" }
              );

              for (const pkg of packages) {
                console.log(`\nChecking: ${pkg.name}`);

                const versions = await github.paginate(
                  github.rest.packages.getAllPackageVersionsForPackageForOrg,
                  { org, package_type: "container", package_name: pkg.name }
                );

                for (const version of versions) {
                  const tags = version.metadata?.container?.tags ?? [];
                  const createdAt = new Date(version.created_at);

                  if (tags.length === 0 && createdAt < cutoffDate) {
                    if (dryRun) {
                      console.log(`  [WOULD DELETE] ID: ${version.id} | Created: ${version.created_at}`);
                    } else {
                      try {
                        await github.rest.packages.deletePackageVersionForOrg({
                          org,
                          package_type: "container",
                          package_name: pkg.name,
                          package_version_id: version.id
                        });
                        console.log(`  [DELETED] ID: ${version.id}`);
                      } catch (err) {
                        console.error(`  [ERROR] Failed to delete ${version.id}: ${err.message}`);
                      }
                    }
                  }
                }
              }
            } catch (error) {
              core.setFailed(`API Error: ${error.message}`);
            }